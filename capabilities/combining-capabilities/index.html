<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Combining capabilities - Pony Tutorial</title>
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../../css/highlight.css">
  <link href="../../css/highlight.css" rel="stylesheet">
  <link href="../../css/theme_extra.css" rel="stylesheet">

  <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/modernizr/2.8.3/modernizr.min.js"></script>
  <script type="text/javascript" src="../../js/highlight.pack.js"></script>
  <script src="../../js/theme.js"></script>
  <script src="../../js/highlight.pack.js"></script>

  <style>
    body {font-size: 90%;}
    pre, code {font-size: 100%;}
    h3, h4, h5, h6 {color: #2980b9; font-weight: 300}
  </style> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> Pony Tutorial</a>
        
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
      <ul class="current">
    
        
        <span>Getting started</span>
            
                <li class="toctree-l1 ">
                    <a class="" href="../..">Welcome!</a>
                    
                </li>
            
                <li class="toctree-l1 ">
                    <a class="" href="../../getting-started/what-you-need-to-start">What you need to start</a>
                    
                </li>
            
                <li class="toctree-l1 ">
                    <a class="" href="../../getting-started/installation">Installation</a>
                    
                </li>
            
                <li class="toctree-l1 ">
                    <a class="" href="../../getting-started/helloworld">Helloworld</a>
                    
                </li>
            
                <li class="toctree-l1 ">
                    <a class="" href="../../getting-started/how-it-works">How it works</a>
                    
                </li>
            
                <li class="toctree-l1 ">
                    <a class="" href="../../getting-started/whitespace">Whitespace</a>
                    
                </li>
            
        

    
        
        <span>Types</span>
            
                <li class="toctree-l1 ">
                    <a class="" href="../../types/static-vs-dynamic">Static vs dynamic</a>
                    
                </li>
            
                <li class="toctree-l1 ">
                    <a class="" href="../../types/classes">Classes</a>
                    
                </li>
            
                <li class="toctree-l1 ">
                    <a class="" href="../../types/primitives">Primitives</a>
                    
                </li>
            
                <li class="toctree-l1 ">
                    <a class="" href="../../types/actors">Actors</a>
                    
                </li>
            
                <li class="toctree-l1 ">
                    <a class="" href="../../types/traits-and-interfaces">Traits and interfaces</a>
                    
                </li>
            
                <li class="toctree-l1 ">
                    <a class="" href="../../types/type-aliases">Type aliases</a>
                    
                </li>
            
                <li class="toctree-l1 ">
                    <a class="" href="../../types/type-expressions">Type expressions</a>
                    
                </li>
            
        

    
        
        <span>Capabilities</span>
            
                <li class="toctree-l1 ">
                    <a class="" href="../introduction">Introduction</a>
                    
                </li>
            
                <li class="toctree-l1 ">
                    <a class="" href="../guarantees">Guarantees</a>
                    
                </li>
            
                <li class="toctree-l1 ">
                    <a class="" href="../aliasing">Aliasing</a>
                    
                </li>
            
                <li class="toctree-l1 current">
                    <a class="current" href=".">Combining capabilities</a>
                    
                        <ul>
                        
                            <li class="toctree-l2"><a href="#viewpoint-adaptation">Viewpoint adaptation</a></li>
                            
                        
                            <li class="toctree-l2"><a href="#explaining-why">Explaining why</a></li>
                            
                                <li><a class="toctree-l3" href="#reading-from-an-iso-variable">Reading from an iso variable</a></li>
                            
                                <li><a class="toctree-l3" href="#reading-from-a-trn-variable">Reading from a trn variable</a></li>
                            
                                <li><a class="toctree-l3" href="#reading-from-a-ref-variable">Reading from a ref variable</a></li>
                            
                                <li><a class="toctree-l3" href="#reading-from-a-val-variable">Reading from a val variable</a></li>
                            
                                <li><a class="toctree-l3" href="#reading-from-a-box-variable">Reading from a box variable</a></li>
                            
                                <li><a class="toctree-l3" href="#reading-from-a-tag-variable">Reading from a tag variable</a></li>
                            
                        
                        </ul>
                    
                </li>
            
                <li class="toctree-l1 ">
                    <a class="" href="../passing-and-sharing">Passing and sharing</a>
                    
                </li>
            
                <li class="toctree-l1 ">
                    <a class="" href="../capability-subtyping">Capability subtyping</a>
                    
                </li>
            
                <li class="toctree-l1 ">
                    <a class="" href="../arrow-types">Arrow types</a>
                    
                </li>
            
        

    
        
        <span>Expressions</span>
            
                <li class="toctree-l1 ">
                    <a class="" href="../../expressions/variables">Variables</a>
                    
                </li>
            
                <li class="toctree-l1 ">
                    <a class="" href="../../expressions/infix-ops">Infix ops</a>
                    
                </li>
            
                <li class="toctree-l1 ">
                    <a class="" href="../../expressions/control-structures">Control structures</a>
                    
                </li>
            
                <li class="toctree-l1 ">
                    <a class="" href="../../expressions/methods">Methods</a>
                    
                </li>
            
                <li class="toctree-l1 ">
                    <a class="" href="../../expressions/exceptions">Exceptions</a>
                    
                </li>
            
                <li class="toctree-l1 ">
                    <a class="" href="../../expressions/sugar">Sugar</a>
                    
                </li>
            
                <li class="toctree-l1 ">
                    <a class="" href="../../expressions/object-literals">Object literals</a>
                    
                </li>
            
                <li class="toctree-l1 ">
                    <a class="" href="../../expressions/partial-application">Partial application</a>
                    
                </li>
            
        

    
        
        <span>Actors</span>
            
                <li class="toctree-l1 ">
                    <a class="" href="../../actors/behaviours">Behaviours</a>
                    
                </li>
            
                <li class="toctree-l1 ">
                    <a class="" href="../../actors/capabilities">Capabilities</a>
                    
                </li>
            
                <li class="toctree-l1 ">
                    <a class="" href="../../actors/recover-and-consume">recover and consume</a>
                    
                </li>
            
                <li class="toctree-l1 ">
                    <a class="" href="../../actors/arrow-types">Arrow types</a>
                    
                </li>
            
        

    
        
        <span>Packages</span>
            
                <li class="toctree-l1 ">
                    <a class="" href="../../packages/package-system">Package system</a>
                    
                </li>
            
                <li class="toctree-l1 ">
                    <a class="" href="../../packages/builtin">Builtin</a>
                    
                </li>
            
                <li class="toctree-l1 ">
                    <a class="" href="../../packages/use-statement">Using a package</a>
                    
                </li>
            
        

    
        
        <span>Composition vs. inheritance</span>
            
                <li class="toctree-l1 ">
                    <a class="" href="../../composition-inheritance/code-sharing">Code sharing</a>
                    
                </li>
            
        

    
        
        <span>Generics</span>
            
                <li class="toctree-l1 ">
                    <a class="" href="../../generics/polymorphic-types">Polymorphic types</a>
                    
                </li>
            
                <li class="toctree-l1 ">
                    <a class="" href="../../generics/polymorphic-methods">Polymorphic methods</a>
                    
                </li>
            
        

    
        
        <span>Pattern matching</span>
            
                <li class="toctree-l1 ">
                    <a class="" href="../../pattern-matching/match">match-expression</a>
                    
                </li>
            
                <li class="toctree-l1 ">
                    <a class="" href="../../pattern-matching/as">as-expression</a>
                    
                </li>
            
        

    
        
        <span>Platform</span>
            
                <li class="toctree-l1 ">
                    <a class="" href="../../platform/platform">Platform</a>
                    
                </li>
            
        

    
        
        <span>Editor support</span>
            
                <li class="toctree-l1 ">
                    <a class="" href="../../editor-plugins/plugins">Plugins</a>
                    
                </li>
            
        

    
        
        <span>Compiler options</span>
            
                <li class="toctree-l1 ">
                    <a class="" href="../../compiler-clargs/clargs">Overview</a>
                    
                </li>
            
        

    
        
        <span>Patterns</span>
            
                <li class="toctree-l1 ">
                    <a class="" href="../../patterns/patterns">Patterns</a>
                    
                </li>
            
        

    
        
        <span>Garbage collection</span>
            
                <li class="toctree-l1 ">
                    <a class="" href="../../garbage-collection/garbage-collection">Garbage collection</a>
                    
                </li>
            
        

    
        
        <span>C-FFI</span>
            
                <li class="toctree-l1 ">
                    <a class="" href="../../c-ffi/calling-c">Calling C programs</a>
                    
                </li>
            
                <li class="toctree-l1 ">
                    <a class="" href="../../c-ffi/linking-c">Linking to C libraries</a>
                    
                </li>
            
                <li class="toctree-l1 ">
                    <a class="" href="../../c-ffi/c-abi">Exposing a C-ABI</a>
                    
                </li>
            
        

    
        
        <span>Examples</span>
            
                <li class="toctree-l1 ">
                    <a class="" href="../../examples/examples">Examples</a>
                    
                </li>
            
        

    
</ul>

      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="icon icon-reorder"></i>
        <a href="../.."></a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    <li>Combining capabilities</li>
      <li class="wy-breadcrumbs-aside">
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              <p>When a field of an object is read, its capability depends both on the capability of the field and the capability of the <strong>origin</strong>, that is, the object the field is being read from.</p>
<p>This is because all the guarantees that the <strong>origin</strong> capability makes have to be maintained for its fields as well.</p>
<h1 id="viewpoint-adaptation">Viewpoint adaptation</h1>
<p>The process of combining origin and field capabilties is called <strong>viewpoint adaptation</strong>. That is, the <strong>origin</strong> has a <strong>viewpoint</strong>, and can "see" its fields only from that <strong>viewpoint</strong>.</p>
<p>Let's start with a table. This shows how <strong>fields</strong> of each capability "look" to <strong>origins</strong> of each capability.</p>
<hr />
<table>
<thead>
<tr>
<th>&#x25B7;</th>
<th>iso field</th>
<th>trn field</th>
<th>ref field</th>
<th>val field</th>
<th>box field</th>
<th>tag field</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>iso origin</strong></td>
<td>iso</td>
<td>tag</td>
<td>tag</td>
<td>val</td>
<td>tag</td>
<td>tag</td>
</tr>
<tr>
<td><strong>trn origin</strong></td>
<td>iso</td>
<td>trn</td>
<td>box</td>
<td>val</td>
<td>box</td>
<td>tag</td>
</tr>
<tr>
<td><strong>ref origin</strong></td>
<td>iso</td>
<td>trn</td>
<td>ref</td>
<td>val</td>
<td>box</td>
<td>tag</td>
</tr>
<tr>
<td><strong>val origin</strong></td>
<td>val</td>
<td>val</td>
<td>val</td>
<td>val</td>
<td>val</td>
<td>tag</td>
</tr>
<tr>
<td><strong>box origin</strong></td>
<td>tag</td>
<td>box</td>
<td>box</td>
<td>val</td>
<td>box</td>
<td>tag</td>
</tr>
<tr>
<td><strong>tag origin</strong></td>
<td>n/a</td>
<td>n/a</td>
<td>n/a</td>
<td>n/a</td>
<td>n/a</td>
<td>n/a</td>
</tr>
</tbody>
</table>
<hr />
<p>For example, if you have a <code>trn</code> origin and you read a <code>ref</code> field, you get a <code>box</code> result:</p>
<pre><code class="pony">class Foo
  var x: String ref

class Bar
  fun f() =&gt;
    var y: Foo trn = getTrnFoo()
    var z: String box = y.x
</code></pre>

<h1 id="explaining-why">Explaining why</h1>
<p>That table will seem totally natural to you, eventually. But probably not yet. To help it seem natural, let's walk through each cell in the table and explain why it is the way it is.</p>
<h2 id="reading-from-an-iso-variable">Reading from an <code>iso</code> variable</h2>
<p>Anything read through an <code>iso</code> origin has to maintain the isolation guarantee that the origin has. The key thing to remember is that the <code>iso</code> can be sent to another actor and it can also become any other capability. So when we read a field, we need to get a result that won't ever break the isolation guarantees that the origin makes, that is, <em>read and write uniqueness</em>.</p>
<p>An <code>iso</code> field makes the same guarantees as an <code>iso</code> origin, so that's fine to read. A <code>val</code> field is <em>globally immutable</em>, which means it's always ok to read it, no matter what the origin is (well, other than <code>tag</code>).</p>
<p>Everything else, though, can break our isolation guarantees. That's why other capabilities are seen as <code>tag</code>: it's the only type that is neither readable nor writeable.</p>
<h2 id="reading-from-a-trn-variable">Reading from a <code>trn</code> variable</h2>
<p>This is like <code>iso</code>, but with a weaker guarantee (<em>write uniqueness</em> as opposed to <em>read and write uniqueness</em>). That makes a big difference, since now we can return something readable when we enforce our guarantees.</p>
<p>An <code>iso</code> field makes stronger guarantees than a <code>trn</code> origin, and a <code>trn</code> field makes the same guarantees, so they're fine to read. A <code>val</code> field is <em>globally immutable</em>, so that's fine too. A <code>box</code> field is readable, and we only guarantee <em>write uniqueness</em>, so that's fine too.</p>
<p>A <code>ref</code> field, though, would allow writing. So instead we return a <code>box</code> capability.</p>
<h2 id="reading-from-a-ref-variable">Reading from a <code>ref</code> variable</h2>
<p>A <code>ref</code> origin doesn't modify its fields at all. This is because a <code>ref</code> origin doesn't make any guarantees that are incompatible with its fields.</p>
<h2 id="reading-from-a-val-variable">Reading from a <code>val</code> variable</h2>
<p>A <code>val</code> origin is deeply and globally immutable, so all of its fields are also <code>val</code>. The only exception is a <code>tag</code> field. Since we can't read from it, we also can't guarantee that nobody can write to it, so it stays <code>tag</code>.</p>
<h2 id="reading-from-a-box-variable">Reading from a <code>box</code> variable</h2>
<p>A <code>box</code> variable is locally immutable. This means it's possible that it may be mutated through some other variable (a <code>trn</code> or a <code>ref</code>), but it's also possible that our <code>box</code> variable is an alias of some <code>val</code> variable.</p>
<p>When we read a field, we need to return a capability that is compatible with the field, but is also locally immutable.</p>
<p>An <code>iso</code> field is returned as a <code>tag</code> because no locally immutable capability can maintain its isolation guarantees. A <code>val</code> field is returned as a <code>val</code> because global immutability is a stronger guarantee than local immutability. A <code>box</code> field makes the same local immutability guarantee as its origin, so that's also fine.</p>
<p>For <code>trn</code> and <code>ref</code> we need to return a locally immutable capability that doesn't violate any guarantees the field makes. In both cases, we can return <code>box</code>.</p>
<h2 id="reading-from-a-tag-variable">Reading from a <code>tag</code> variable</h2>
<p>This one is easy: <code>tag</code> variables are opaque! They can't be read from.</p>

            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../passing-and-sharing" class="btn btn-neutral float-right" title="Passing and sharing"/>Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../aliasing" class="btn btn-neutral" title="Aliasing"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
    <!-- Copyright etc -->
    </p>
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
	  
        </div>
      </div>

    </section>

  </div>

<div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
        
      <span><a href="../aliasing" style="color: #fcfcfc;">&laquo; Previous</a></span>
      <span style="margin-left: 15px"><a href="../passing-and-sharing" style="color: #fcfcfc">Next &raquo;</a></span>
    </span>
</div>
</body>
</html>